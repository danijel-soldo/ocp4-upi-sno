---
# Test playbook for static IP feature
# This validates the feature without performing actual installation
# Run with: ansible-playbook -i localhost, tests/test_static_ip.yml

- name: Test Static IP Feature
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    test_results: []
    test_workdir: "/tmp/ocp4-sno-test"
    
  tasks:
    - name: Create test working directory
      file:
        path: "{{ test_workdir }}"
        state: directory
        mode: '0755'

    - name: "TEST 1: Validate DHCP mode (default behavior)"
      block:
        - name: Set DHCP mode variables
          set_fact:
            helper:
              name: "helper"
              ipaddr: "192.168.79.2"
            dns:
              domain: "cloud.lab"
              clusterid: "sno"
              forwarder1: "9.9.9.9"
            dhcp:
              router: "192.168.79.2"
              netmask: "255.255.255.0"
              enabled: true
            sno:
              name: "sno"
              ipaddr: "192.168.79.10"
              macaddr: "fa:4e:86:23:37:20"
              disk: "/dev/sda"
              pvmcec: "Server-9080-HEX"
              pvmlpar: "test-lpar"
            pvm_hmc: "hmc_user@hmc.test"
            networkifacename: "env32"

        - name: Test dnsmasq template rendering (DHCP mode)
          template:
            src: ../templates/dnsmasq.conf.j2
            dest: "{{ test_workdir }}/dnsmasq-dhcp.conf"

        - name: Verify DHCP section exists in config
          shell: grep -q "dhcp-range" "{{ test_workdir }}/dnsmasq-dhcp.conf"
          register: dhcp_check
          failed_when: dhcp_check.rc != 0

        - name: Verify dhcp-boot directive exists
          shell: grep -q "dhcp-boot=boot/grub2/powerpc-ieee1275/core.elf" "{{ test_workdir }}/dnsmasq-dhcp.conf"
          register: dhcp_boot_check
          failed_when: dhcp_boot_check.rc != 0

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 1 PASSED: DHCP mode configuration correct'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 1 FAILED: DHCP mode configuration incorrect'] }}"

    - name: "TEST 2: Validate Static IP mode"
      block:
        - name: Set Static IP mode variables
          set_fact:
            dhcp:
              router: "192.168.79.2"
              netmask: "255.255.255.0"
              enabled: false

        - name: Test dnsmasq template rendering (Static IP mode)
          template:
            src: ../templates/dnsmasq.conf.j2
            dest: "{{ test_workdir }}/dnsmasq-static.conf"

        - name: Verify DHCP section does NOT exist
          shell: grep -q "dhcp-range" "{{ test_workdir }}/dnsmasq-static.conf"
          register: no_dhcp_check
          failed_when: no_dhcp_check.rc == 0

        - name: Verify TFTP is still enabled
          shell: grep -q "enable-tftp" "{{ test_workdir }}/dnsmasq-static.conf"
          register: tftp_check
          failed_when: tftp_check.rc != 0

        - name: Verify static IP comment exists
          shell: grep -q "DHCP is disabled" "{{ test_workdir }}/dnsmasq-static.conf"
          register: comment_check
          failed_when: comment_check.rc != 0

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 2 PASSED: Static IP mode configuration correct'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 2 FAILED: Static IP mode configuration incorrect'] }}"

    - name: "TEST 3: Validate GRUB configuration with DHCP"
      block:
        - name: Set DHCP enabled
          set_fact:
            dhcp:
              router: "192.168.79.2"
              netmask: "255.255.255.0"
              enabled: true
            ignition: "sno.ign"
            mac: "fa:4e:86:23:37:20"
            coreos_inst_url: "coreos.live.rootfs_url=http://192.168.79.2:8000/install/rootfs.img"
            ignition_url: "http://192.168.79.2:8000/ignition"

        - name: Set IP config fact for DHCP
          set_fact:
            ip_config: "{% if dhcp.enabled | default(true) %}ip=dhcp{% else %}ip={{ sno.ipaddr }}::{{ dhcp.router }}:{{ dhcp.netmask }}:{{ sno.name }}.{{ dns.clusterid }}.{{ dns.domain }}:{{ networkifacename }}:none nameserver={{ helper.ipaddr }}{% endif %}"

        - name: Verify DHCP IP config
          assert:
            that:
              - ip_config == "ip=dhcp"
            fail_msg: "DHCP IP config should be 'ip=dhcp'"
            success_msg: "DHCP IP config is correct"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 3 PASSED: GRUB DHCP configuration correct'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 3 FAILED: GRUB DHCP configuration incorrect'] }}"

    - name: "TEST 4: Validate GRUB configuration with Static IP"
      block:
        - name: Set Static IP enabled
          set_fact:
            dhcp:
              router: "192.168.79.2"
              netmask: "255.255.255.0"
              enabled: false

        - name: Set IP config fact for Static IP
          set_fact:
            ip_config: "{% if dhcp.enabled | default(true) %}ip=dhcp{% else %}ip={{ sno.ipaddr }}::{{ dhcp.router }}:{{ dhcp.netmask }}:{{ sno.name }}.{{ dns.clusterid }}.{{ dns.domain }}:{{ networkifacename }}:none nameserver={{ helper.ipaddr }}{% endif %}"

        - name: Verify Static IP config format
          assert:
            that:
              - "'ip=192.168.79.10' in ip_config"
              - "'192.168.79.2' in ip_config"
              - "'255.255.255.0' in ip_config"
              - "'nameserver=192.168.79.2' in ip_config"
            fail_msg: "Static IP config format is incorrect"
            success_msg: "Static IP config format is correct"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 4 PASSED: GRUB Static IP configuration correct'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 4 FAILED: GRUB Static IP configuration incorrect'] }}"

    - name: "TEST 5: Validate firewall ports with DHCP"
      block:
        - name: Set DHCP mode
          set_fact:
            dhcp:
              enabled: true

        - name: Set firewall ports with DHCP
          when: dhcp.enabled | default(true)
          set_fact:
            ports:
              - 67/udp
              - 53/tcp
              - 53/udp
              - 443/tcp
              - 80/tcp
              - 8080/tcp
              - 6443/tcp
              - 6443/udp
              - 22623/tcp
              - 22623/udp
              - 69/udp

        - name: Verify DHCP port is included
          assert:
            that:
              - "'67/udp' in ports"
            fail_msg: "DHCP port 67/udp should be included"
            success_msg: "DHCP port 67/udp is correctly included"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 5 PASSED: Firewall ports with DHCP correct'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 5 FAILED: Firewall ports with DHCP incorrect'] }}"

    - name: "TEST 6: Validate firewall ports without DHCP"
      block:
        - name: Set Static IP mode
          set_fact:
            dhcp:
              enabled: false

        - name: Set firewall ports without DHCP
          when: not (dhcp.enabled | default(true))
          set_fact:
            ports_static:
              - 53/tcp
              - 53/udp
              - 443/tcp
              - 80/tcp
              - 8080/tcp
              - 6443/tcp
              - 6443/udp
              - 22623/tcp
              - 22623/udp
              - 69/udp

        - name: Verify DHCP port is NOT included
          assert:
            that:
              - "'67/udp' not in ports_static"
            fail_msg: "DHCP port 67/udp should NOT be included in static mode"
            success_msg: "DHCP port 67/udp is correctly excluded"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 6 PASSED: Firewall ports without DHCP correct'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 6 FAILED: Firewall ports without DHCP incorrect'] }}"

    - name: "TEST 7: Validate netboot command with DHCP"
      block:
        - name: Set DHCP mode
          set_fact:
            dhcp:
              enabled: true
              router: "192.168.79.2"
              netmask: "255.255.255.0"

        - name: Build netboot command for DHCP
          set_fact:
            netboot_cmd_dhcp: "lpar_netboot -i -D -f -t ent -m {{ sno.macaddr | replace(':', '') }} -s auto -d auto -S {{ helper.ipaddr }} -C {{ sno.ipaddr }} -G {{ dhcp.router }} -K {{ dhcp.netmask }}"

        - name: Verify -D flag is present
          assert:
            that:
              - "'-D' in netboot_cmd_dhcp"
            fail_msg: "DHCP mode should include -D flag"
            success_msg: "DHCP mode correctly includes -D flag"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 7 PASSED: Netboot command with DHCP correct'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 7 FAILED: Netboot command with DHCP incorrect'] }}"

    - name: "TEST 8: Validate netboot command without DHCP"
      block:
        - name: Set Static IP mode
          set_fact:
            dhcp:
              enabled: false
              router: "192.168.79.2"
              netmask: "255.255.255.0"

        - name: Build netboot command for Static IP
          set_fact:
            netboot_cmd_static: "lpar_netboot -i -f -t ent -m {{ sno.macaddr | replace(':', '') }} -s auto -d auto -S {{ helper.ipaddr }} -C {{ sno.ipaddr }} -G {{ dhcp.router }} -K {{ dhcp.netmask }}"

        - name: Verify -D flag is NOT present
          assert:
            that:
              - "'-D' not in netboot_cmd_static"
            fail_msg: "Static IP mode should NOT include -D flag"
            success_msg: "Static IP mode correctly excludes -D flag"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 8 PASSED: Netboot command without DHCP correct'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 8 FAILED: Netboot command without DHCP incorrect'] }}"

    - name: "TEST 9: Validate backward compatibility (dhcp.enabled not set)"
      block:
        - name: Unset dhcp.enabled to test default
          set_fact:
            dhcp:
              router: "192.168.79.2"
              netmask: "255.255.255.0"

        - name: Test default behavior
          set_fact:
            default_enabled: "{{ dhcp.enabled | default(true) }}"

        - name: Verify default is true
          assert:
            that:
              - default_enabled == true
            fail_msg: "Default should be DHCP enabled (true)"
            success_msg: "Default correctly set to DHCP enabled"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 9 PASSED: Backward compatibility maintained'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 9 FAILED: Backward compatibility broken'] }}"

    - name: "TEST 10: Validate IP address format validation"
      block:
        - name: Test valid IP
          set_fact:
            valid_ip: "192.168.79.10"
            invalid_ip: "999.999.999.999"

        - name: Check valid IP format
          assert:
            that:
              - valid_ip | regex_search('^([0-9]{1,3}\.){3}[0-9]{1,3}$')
            fail_msg: "Valid IP should match regex"
            success_msg: "Valid IP format check works"

        - name: Check invalid IP format
          assert:
            that:
              - invalid_ip | regex_search('^([0-9]{1,3}\.){3}[0-9]{1,3}$')
            fail_msg: "Invalid IP correctly rejected"
            success_msg: "This should fail"
          ignore_errors: yes
          register: invalid_check

        - name: Verify invalid IP was rejected
          assert:
            that:
              - invalid_check.failed
            fail_msg: "Invalid IP should be rejected"
            success_msg: "Invalid IP correctly rejected"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 10 PASSED: IP validation works correctly'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 10 FAILED: IP validation incorrect'] }}"

    - name: "TEST 11: Validate MAC address format validation"
      block:
        - name: Test valid MAC
          set_fact:
            valid_mac: "fa:4e:86:23:37:20"
            invalid_mac: "invalid:mac:address"

        - name: Check valid MAC format
          assert:
            that:
              - valid_mac | regex_search('^([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}$')
            fail_msg: "Valid MAC should match regex"
            success_msg: "Valid MAC format check works"

        - name: Check invalid MAC format
          assert:
            that:
              - invalid_mac | regex_search('^([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}$')
            fail_msg: "Invalid MAC correctly rejected"
            success_msg: "This should fail"
          ignore_errors: yes
          register: invalid_mac_check

        - name: Verify invalid MAC was rejected
          assert:
            that:
              - invalid_mac_check.failed
            fail_msg: "Invalid MAC should be rejected"
            success_msg: "Invalid MAC correctly rejected"

        - name: Record test result
          set_fact:
            test_results: "{{ test_results + ['✅ TEST 11 PASSED: MAC validation works correctly'] }}"
      rescue:
        - set_fact:
            test_results: "{{ test_results + ['❌ TEST 11 FAILED: MAC validation incorrect'] }}"

    - name: Display test results summary
      debug:
        msg: "{{ test_results }}"

    - name: Count passed tests
      set_fact:
        passed_count: "{{ test_results | select('match', '^✅.*') | list | length }}"
        failed_count: "{{ test_results | select('match', '^❌.*') | list | length }}"

    - name: Display final summary
      debug:
        msg:
          - "=========================================="
          - "TEST SUITE SUMMARY"
          - "=========================================="
          - "Total Tests: {{ test_results | length }}"
          - "Passed: {{ passed_count }}"
          - "Failed: {{ failed_count }}"
          - "=========================================="

    - name: Fail if any tests failed
      fail:
        msg: "{{ failed_count }} test(s) failed. Review output above."
      when: failed_count | int > 0

    - name: Cleanup test directory
      file:
        path: "{{ test_workdir }}"
        state: absent

# Made with Bob
