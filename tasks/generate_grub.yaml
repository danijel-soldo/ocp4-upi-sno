---
# GRUB Boot Configuration
#
# This task generates the GRUB configuration for PXE network boot.
# The key difference between DHCP and Static IP modes is in the kernel boot parameters.
#
# DHCP Mode: Uses "ip=dhcp" kernel parameter
#            - LPAR will request IP address from DHCP server during boot
#            - Requires dnsmasq DHCP service to be running
#
# Static IP Mode: Uses explicit IP configuration in kernel parameters
#                 - Format: ip=<client-ip>::<gateway>:<netmask>:<hostname>:<interface>:none nameserver=<dns>
#                 - LPAR configures network interface with these parameters during boot
#                 - No DHCP server required
#                 - This is where the actual static IP configuration happens (not in lpar_netboot)
#
# Reference: https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt

- name: Set IP configuration for kernel boot parameters
  set_fact:
    ip_config: "{% if dhcp.enabled | default(true) %}ip=dhcp{% else %}ip={{ sno.ipaddr }}::{{ dhcp.router }}:{{ dhcp.netmask }}:{{ sno.name }}.{{ dns.clusterid }}.{{ dns.domain }}:{{ networkifacename }}:none nameserver={{ helper.ipaddr }}{% endif %}"

- name: create grub2 block
  when: ignition == "sno.ign"
  blockinfile:
    marker: ""
    content: |
      if [ ${net_default_mac} == {{ mac }} ]; then
      default=0
      fallback=1
      timeout=1
      menuentry "CoreOS (BIOS)" {
         echo "Loading kernel"
         linux "/rhcos/kernel" {{ ip_config }} rd.neednet=1 ignition.platform.id=metal ignition.firstboot {{ coreos_inst_url }} ignition.config.url={{ ignition_url }}/{{ ignition }}

         echo "Loading initrd"
         initrd  "/rhcos/initramfs.img"
      }
      fi
    dest: /var/lib/tftpboot/boot/grub2/grub.cfg

- name: Set IP configuration for day2 worker kernel boot parameters
  when: ignition == "day2-worker.ign"
  set_fact:
    ip_config_day2: "{% if dhcp.enabled | default(true) %}ip=dhcp{% else %}ip={{ day2_worker.ipaddr }}::{{ dhcp.router }}:{{ dhcp.netmask }}:{{ day2_worker.name }}.{{ dns.clusterid }}.{{ dns.domain }}:{{ networkifacename }}:none nameserver={{ helper.ipaddr }}{% endif %}"

- name: create grub2 block for day2 worker
  when: ignition == "day2-worker.ign"
  blockinfile:
    marker: ""
    content: |
      if [ ${net_default_mac} == {{ mac }} ]; then
      default=0
      fallback=1
      timeout=1
      menuentry "CoreOS (BIOS)" {
         echo "Loading kernel"
         linux "/rhcos/kernel" {{ ip_config_day2 }} rd.neednet=1 coreos.inst=yes coreos.inst.install_dev={{ mdisk }} {{ coreos_inst_url }} coreos.inst.ignition_url={{ ignition_url }}/{{ ignition }} ignition.config.url={{ ignition_url }}/first-boot-day2-ppc64le.ign

         echo "Loading initrd"
         initrd  "/rhcos/initramfs.img"
      }
      fi
    dest: /var/lib/tftpboot/boot/grub2/grub.cfg

