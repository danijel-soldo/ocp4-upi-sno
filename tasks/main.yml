---
# Setup OCP SNO Helper Node

- hosts: all
  vars_files:
    - ../defaults/main.yaml
  handlers:
  - import_tasks: ../handlers/main.yml

  tasks:
  - name: Install required Ansible collections
    delegate_to: localhost
    become: false
    shell: ansible-galaxy collection install ansible.posix --force
    register: collection_install
    changed_when: "'was installed successfully' in collection_install.stdout"
    failed_when: collection_install.rc != 0

  - name: Validate configuration
    include_tasks: validate_config.yaml

  - name: Clean up work directory
    file:
      path: "{{ workdir }}/"
      state: absent

  - name: Set setup facts
    include_tasks: set_facts.yaml

  - name: Setup required services
    #become: true
    include_tasks: setup_services.yaml

  - name: setup tftp
    #become: true
    include_tasks: setup_tftp.yaml

  - name: Download OCP files
    #become: true
    include_tasks: download_files.yaml

  - name: Setup Local Registry
    #become: true
    when: setup_registry is defined and setup_registry.deploy
    block:
    - name: Install registry packages
      become: true
      package:
        name: "{{ registry }}"
        state: present

    - name: Setup Registry
      include_tasks: setup_registry.yaml

  - name: Start firewalld service
    become: true
    systemd:
      name: firewalld
      state: started
      enabled: yes

  - name: Open up firewall ports
    become: true
    ansible.posix.firewalld:
      permanent: yes
      immediate: yes
      state: enabled
      port: "{{ item[0] }}"
    delegate_to: "{{ item[1] }}"
    run_once: true
    with_nested:
      - "{{ ports }}"
      - "{{ ansible_play_batch }}"

  - name: Best effort SELinux repair - Apache
    become: true
    shell: "restorecon -vR /var/www/html || true"


  - name: Systemd daemon reload
    become: true
    systemd:
      daemon_reload: yes

  - name: Starting services
    become: true
    service:
      name: "{{ item }}"
      enabled: yes
      state: restarted
    with_items:
      - "{{ services }}"

  - name: Check dnsmasq configuration and status
    become: true
    shell: |
      echo "=== dnsmasq.conf interface setting ==="
      grep "^interface=" /etc/dnsmasq.conf || echo "No interface setting found"
      echo ""
      echo "=== dnsmasq process status ==="
      systemctl status dnsmasq --no-pager || true
      echo ""
      echo "=== dnsmasq listening ports ==="
      netstat -tulpn | grep dnsmasq || echo "dnsmasq not listening on any ports"
      echo ""
      echo "=== Interface env32 status ==="
      ip addr show env32 || echo "Interface env32 not found"
    register: dnsmasq_debug
    ignore_errors: yes

  - name: Display dnsmasq diagnostic information
    debug:
      var: dnsmasq_debug.stdout_lines

  - name: Verify dnsmasq ports are listening (using netstat)
    become: true
    shell: |
      netstat -tulpn | grep -E ":(53|67|69) " | grep dnsmasq
    register: dnsmasq_ports
    retries: 5
    delay: 2
    until: dnsmasq_ports.rc == 0
    changed_when: false
    when: dhcp.enabled | default(true)

  - name: Verify dnsmasq ports are listening for static IP mode
    become: true
    shell: |
      netstat -tulpn | grep -E ":(53|67|69) " | grep dnsmasq
    register: dnsmasq_ports_static
    retries: 5
    delay: 2
    until: dnsmasq_ports_static.rc == 0
    changed_when: false
    when: not (dhcp.enabled | default(true))

  - name: Display dnsmasq listening ports
    debug:
      msg: "{{ (dnsmasq_ports.stdout_lines | default([])) + (dnsmasq_ports_static.stdout_lines | default([])) }}"

  - name: Verify dnsmasq service status
    become: true
    systemd:
      name: dnsmasq
      state: started
    register: dnsmasq_status
    failed_when: dnsmasq_status.status.ActiveState != 'active'

  # DISABLED: This task overwrites /etc/resolv.conf and breaks external DNS resolution
  # The helper node needs to use system DNS to resolve HMC and other external hosts
  # Configure DNS via NetworkManager or manually, then make resolv.conf immutable
  # - name: Set the local resolv.conf file
  #   become: true
  #   template:
  #     src: ../templates/resolv.conf.j2
  #     dest: /etc/resolv.conf

  - name: create ocp install files
    include_tasks: create_ocp_files.yaml

  - name: Netboot all the LPARs
    include_tasks: netboot.yaml

  - name: Waiting for bootstrap completed
    shell: "openshift-install wait-for bootstrap-complete --log-level {{ log_level }}"
    args:
      chdir: "{{ workdir }}"

  - name: Waiting for installation completed
    shell: "openshift-install wait-for install-complete --log-level {{ log_level }}"
    args:
      chdir: "{{ workdir }}"

  - name: stop httpd after installation completed
    service:
      name: httpd
      state: stopped